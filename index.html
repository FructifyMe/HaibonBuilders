<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haibon Builders - Estimates & Invoices</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #1a2744;
            --gold: #c9a227;
            --gold-light: #e8d48a;
            --cream: #faf8f3;
            --white: #ffffff;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-400: #a3a3a3;
            --gray-600: #525252;
            --gray-800: #262626;
            --red: #dc2626;
            --green: #16a34a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--navy);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-section img {
            height: 50px;
            width: auto;
        }

        .logo-text {
            color: var(--white);
        }

        .logo-text h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            font-weight: 400;
        }

        .logo-text span {
            font-size: 0.75rem;
            color: var(--gold);
            letter-spacing: 0.05em;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: var(--gold);
            color: var(--navy);
        }

        /* Main Layout */
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Document Type Toggle */
        .doc-type-toggle {
            display: flex;
            background: var(--white);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .doc-type-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .doc-type-btn.active {
            background: var(--navy);
            color: var(--white);
        }

        /* Voice Section */
        .voice-section {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .voice-section h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--navy);
        }

        .voice-hint {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .voice-hint code {
            background: var(--gray-100);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.8125rem;
        }

        .voice-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .mic-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--navy);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .mic-btn:hover {
            background: var(--gray-100);
        }

        .mic-btn.recording {
            background: var(--red);
            border-color: var(--red);
            animation: pulse 1.5s infinite;
        }

        .mic-btn.recording svg {
            fill: var(--white);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .mic-btn svg {
            width: 32px;
            height: 32px;
            fill: var(--navy);
        }

        .voice-status {
            flex: 1;
            min-width: 200px;
        }

        .status-text {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.25rem;
        }

        .status-text.recording {
            color: var(--red);
        }

        .status-text.processing {
            color: var(--gold);
        }

        .transcript-preview {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-style: italic;
            max-height: 60px;
            overflow-y: auto;
        }

        /* Document Card */
        .document-card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .doc-header {
            background: var(--navy);
            color: var(--white);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .doc-header-left h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .doc-number {
            font-size: 0.875rem;
            color: var(--gold);
            margin-top: 0.25rem;
        }

        .doc-header-right {
            text-align: right;
        }

        .doc-header-right img {
            height: 40px;
            margin-bottom: 0.5rem;
        }

        .company-info {
            font-size: 0.75rem;
            line-height: 1.4;
            opacity: 0.9;
        }

        .doc-body {
            padding: 1.5rem;
        }

        /* Customer Info */
        .customer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .form-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input, .form-group textarea {
            padding: 0.625rem;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--navy);
        }

        /* Line Items */
        .line-items-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .line-items-table th {
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .line-items-table th:last-child {
            text-align: right;
            width: 120px;
        }

        .line-items-table th:nth-child(3) {
            width: 50px;
        }

        .line-item-row td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .line-item-row input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-size: 0.9375rem;
            font-family: inherit;
        }

        .line-item-row input:focus {
            outline: none;
            border-color: var(--navy);
        }

        .line-item-row input[type="number"] {
            text-align: right;
        }

        .delete-item-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .delete-item-btn:hover {
            background: var(--red);
            color: var(--white);
        }

        .add-item-btn {
            margin-top: 0.75rem;
            padding: 0.625rem 1rem;
            background: var(--gray-100);
            border: 1px dashed var(--gray-400);
            border-radius: 6px;
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .add-item-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-600);
        }

        /* Totals */
        .totals-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--navy);
            display: flex;
            justify-content: flex-end;
        }

        .totals-box {
            width: 250px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9375rem;
        }

        .total-row.grand-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--navy);
            border-top: 2px solid var(--gray-200);
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }

        /* Notes */
        .notes-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .notes-section textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: var(--navy);
            color: var(--white);
            border: none;
        }

        .btn-primary:hover {
            background: #243352;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--navy);
            border: 2px solid var(--navy);
        }

        .btn-secondary:hover {
            background: var(--gray-100);
        }

        .btn-gold {
            background: var(--gold);
            color: var(--navy);
            border: none;
        }

        .btn-gold:hover {
            background: var(--gold-light);
        }

        /* Saved Documents Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 1.25rem;
            color: var(--navy);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            padding: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .saved-doc-item {
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-doc-item:hover {
            border-color: var(--navy);
            background: var(--gray-100);
        }

        .saved-doc-item h4 {
            font-size: 1rem;
            color: var(--navy);
            margin-bottom: 0.25rem;
        }

        .saved-doc-meta {
            font-size: 0.8125rem;
            color: var(--gray-600);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .saved-doc-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .saved-doc-actions button {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .no-docs-message {
            text-align: center;
            padding: 2rem;
            color: var(--gray-600);
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .header, .voice-section, .action-buttons, .modal-overlay,
            .doc-type-toggle, .delete-item-btn, .add-item-btn {
                display: none !important;
            }
            
            .main-container {
                padding: 0;
                max-width: none;
            }
            
            .document-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .form-group input, .form-group textarea,
            .line-item-row input {
                border: none;
                padding: 0.25rem 0;
                background: transparent;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .logo-section {
                flex-direction: column;
            }
            
            .doc-header {
                flex-direction: column;
            }
            
            .doc-header-right {
                text-align: left;
            }
            
            .line-items-table th:nth-child(1),
            .line-items-table td:nth-child(1) {
                display: none;
            }
            
            .action-btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--navy);
            color: var(--white);
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background: var(--red);
        }

        .toast.success {
            background: var(--green);
        }
    </style>
</head>
<body>

<header class="header">
    <div class="logo-section">
        <img src="https://haibonbuilders.com/wp-content/uploads/2022/05/haibon.png" alt="Haibon Builders">
        <div class="logo-text">
            <h1>Haibon Builders</h1>
            <span>SINCE 1977</span>
        </div>
    </div>
    <div class="header-actions">
        <button class="header-btn" onclick="openSavedDocs()">Saved Docs</button>
        <button class="header-btn" onclick="newDocument()">New</button>
    </div>
</header>

<main class="main-container">
    <!-- Document Type Toggle -->
    <div class="doc-type-toggle">
        <button class="doc-type-btn active" data-type="estimate" onclick="setDocType('estimate')">Estimate</button>
        <button class="doc-type-btn" data-type="invoice" onclick="setDocType('invoice')">Invoice</button>
    </div>

    <!-- Voice Input Section -->
    <section class="voice-section">
        <h2>üé§ Voice Input</h2>
        <p class="voice-hint">
            <strong>Say items with prices:</strong> <code>tile work 1200</code> <code>labor 850</code> <code>plumbing 500</code><br>
            <strong>Set customer:</strong> <code>customer John Smith</code> or <code>for John Smith</code><br>
            <strong>Set address:</strong> <code>at 45 Oak Street Danvers</code><br>
            <strong>Set project:</strong> <code>project bathroom remodel</code>
        </p>
        <div class="voice-controls">
            <button class="mic-btn" id="micBtn" onclick="toggleRecording()">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <div class="voice-status">
                <div class="status-text" id="statusText">Tap microphone to start</div>
                <div class="transcript-preview" id="transcriptPreview"></div>
            </div>
        </div>
    </section>

    <!-- Document Card -->
    <div class="document-card">
        <div class="doc-header">
            <div class="doc-header-left">
                <h3 id="docTitle">Estimate</h3>
                <div class="doc-number" id="docNumber">#EST-001</div>
            </div>
            <div class="doc-header-right">
                <img src="https://haibonbuilders.com/wp-content/uploads/2022/05/haibon.png" alt="Haibon Builders">
                <div class="company-info">
                    105 Conant St, Danvers, MA 01923<br>
                    (978) 774-4224<br>
                    <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="acc4cdc5cec3c2ced9c5c0c8c9dedf9d959b9beccbc1cdc5c082cfc3c1">[email&#160;protected]</a>
                </div>
            </div>
        </div>
        
        <div class="doc-body">
            <!-- Customer Info -->
            <div class="customer-section">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="customerName" placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="customerAddress" placeholder="123 Main St, Danvers, MA">
                </div>
                <div class="form-group">
                    <label>Phone / Email</label>
                    <input type="text" id="customerContact" placeholder="(978) 555-1234">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="docDate">
                </div>
            </div>

            <!-- Project Description -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label>Project Description</label>
                <input type="text" id="projectDesc" placeholder="Kitchen Remodel, Deck Construction, etc.">
            </div>

            <!-- Line Items -->
            <div class="line-items-section">
                <h4>Line Items</h4>
                <table class="line-items-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th>Description</th>
                            <th></th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="lineItemsBody">
                        <!-- Line items will be added here -->
                    </tbody>
                </table>
                <button class="add-item-btn" onclick="addLineItem()">+ Add Line Item</button>
            </div>

            <!-- Totals -->
            <div class="totals-section">
                <div class="totals-box">
                    <div class="total-row grand-total">
                        <span>Total</span>
                        <span id="grandTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="notes-section">
                <div class="form-group">
                    <label>Notes / Terms</label>
                    <textarea id="docNotes" placeholder="Payment terms, project timeline, etc."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="action-btn btn-primary" onclick="saveDocument()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
            Save
        </button>
        <button class="action-btn btn-secondary" onclick="window.print()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
            Print / PDF
        </button>
        <button class="action-btn btn-gold" id="convertBtn" onclick="convertDocument()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg>
            Convert to Invoice
        </button>
    </div>
</main>

<!-- Saved Documents Modal -->
<div class="modal-overlay" id="savedDocsModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Saved Documents</h3>
            <button class="modal-close" onclick="closeSavedDocs()">&times;</button>
        </div>
        <div class="modal-body" id="savedDocsList">
            <!-- Saved documents will be listed here -->
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ========== State ==========
    let currentDoc = {
        id: null,
        type: 'estimate',
        number: 'EST-001',
        customerName: '',
        customerAddress: '',
        customerContact: '',
        date: new Date().toISOString().split('T')[0],
        projectDesc: '',
        lineItems: [],
        notes: '',
        createdAt: null
    };

    let lineItemCounter = 0;
    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';

    // ========== Initialize ==========
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('docDate').value = currentDoc.date;
        addLineItem(); // Start with one empty line item
        initSpeechRecognition();
        generateDocNumber();
    });

    // ========== Speech Recognition ==========
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            document.getElementById('statusText').textContent = 'Voice input not supported in this browser';
            document.getElementById('micBtn').disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            
            document.getElementById('transcriptPreview').textContent = 
                finalTranscript + (interimTranscript ? '...' + interimTranscript : '');
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            if (event.error !== 'no-speech') {
                stopRecording();
                showToast('Voice recognition error: ' + event.error, 'error');
            }
        };

        recognition.onend = function() {
            if (isRecording) {
                // Automatically restart if still recording
                try {
                    recognition.start();
                } catch(e) {
                    // Ignore if already started
                }
            }
        };
    }

    function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }

    function startRecording() {
        if (!recognition) return;
        
        finalTranscript = '';
        isRecording = true;
        
        try {
            recognition.start();
        } catch(e) {
            // Already started
        }
        
        document.getElementById('micBtn').classList.add('recording');
        document.getElementById('statusText').textContent = 'Listening... Tap to stop';
        document.getElementById('statusText').classList.add('recording');
        document.getElementById('transcriptPreview').textContent = '';
    }

    function stopRecording() {
        isRecording = false;
        if (recognition) {
            recognition.stop();
        }
        
        document.getElementById('micBtn').classList.remove('recording');
        document.getElementById('statusText').classList.remove('recording');
        
        if (finalTranscript.trim()) {
            document.getElementById('statusText').textContent = 'Processing...';
            document.getElementById('statusText').classList.add('processing');
            parseVoiceInput(finalTranscript);
        } else {
            document.getElementById('statusText').textContent = 'Tap microphone to start';
        }
    }

    // ========== Local Voice Parsing (No API needed!) ==========
    function parseVoiceInput(transcript) {
        const text = transcript.toLowerCase().trim();
        const originalText = transcript.trim();
        let itemsFound = 0;
        
        console.log('Parsing transcript:', text);
        
        // Helper: Convert price strings to numbers
        function parsePrice(str) {
            if (!str) return null;
            // Remove $ and commas, parse as float
            const cleaned = str.replace(/[$,]/g, '').trim();
            const num = parseFloat(cleaned);
            return isNaN(num) ? null : num;
        }
        
        // Helper: Capitalize words
        function capitalize(str) {
            return str.split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                .join(' ');
        }
        
        // ===== 1. Extract Phone Number =====
        // Patterns: 978-555-1212, 978.555.1212, 9785551212, (978) 555-1212
        const phonePatterns = [
            /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/,
            /\d{3}[-.\s]\d{2,3}[-.\s]\d{4}/
        ];
        for (const pattern of phonePatterns) {
            const phoneMatch = text.match(pattern);
            if (phoneMatch) {
                document.getElementById('customerContact').value = phoneMatch[0];
                console.log('Found phone:', phoneMatch[0]);
                break;
            }
        }
        
        // ===== 2. Extract Price (dollar amounts) =====
        // Look for: $12,000 or $12000 or 12,000 dollars or "for $X"
        const pricePatterns = [
            /\$[\d,]+(?:\.\d{2})?/g,
            /(?:for|total|price|cost|quote)\s*\$?(\d[\d,]*(?:\.\d{2})?)/gi,
            /(\d{1,3}(?:,\d{3})+(?:\.\d{2})?)\s*(?:dollars?|bucks?)?/g,
            /(\d{4,}(?:\.\d{2})?)\s*(?:dollars?|bucks?)?/g
        ];
        
        let foundPrice = null;
        let priceDescription = null;
        
        // First, look for "X for $Y" pattern (e.g., "kitchen remodel for $12,000")
        const descPriceMatch = text.match(/([a-z][a-z\s]+?)\s+(?:for|at|price|cost|quote)?\s*\$?([\d,]+(?:\.\d{2})?)\s*(?:dollars?|bucks?)?$/i);
        if (descPriceMatch) {
            priceDescription = descPriceMatch[1].trim();
            foundPrice = parsePrice(descPriceMatch[2]);
            console.log('Found desc+price pattern:', priceDescription, foundPrice);
        }
        
        // Also check for standalone price
        if (!foundPrice) {
            for (const pattern of pricePatterns) {
                const matches = text.match(pattern);
                if (matches) {
                    for (const m of matches) {
                        const price = parsePrice(m.replace(/.*?(\$?[\d,]+).*/, '$1'));
                        if (price && price >= 100) { // Assume prices are at least $100
                            foundPrice = price;
                            console.log('Found price:', foundPrice);
                            break;
                        }
                    }
                }
                if (foundPrice) break;
            }
        }
        
        // ===== 3. Extract Address =====
        // Look for: number + street name (with or without "at")
        const streetTypes = 'street|st|avenue|ave|road|rd|drive|dr|lane|ln|way|circle|cir|court|ct|boulevard|blvd|place|pl|terrace|ter|highway|hwy';
        const addressPattern = new RegExp(`(\\d+\\s+[a-z]+(?:\\s+[a-z]+)?\\s+(?:${streetTypes}))`, 'i');
        const addressMatch = text.match(addressPattern);
        if (addressMatch) {
            document.getElementById('customerAddress').value = capitalize(addressMatch[1]);
            console.log('Found address:', addressMatch[1]);
        }
        
        // ===== 4. Extract Customer Name =====
        // Look for: "for [Name]" at the beginning, or name patterns before address/phone
        const namePatterns = [
            /(?:estimate|invoice|quote)?\s*(?:for|customer|client)\s+([a-z]+\s+[a-z]+)/i,
            /^(?:new\s+)?(?:estimate|invoice|quote)?\s*(?:for)?\s*([a-z]+\s+[a-z]+)\s+\d/i
        ];
        
        for (const pattern of namePatterns) {
            const nameMatch = text.match(pattern);
            if (nameMatch) {
                const name = nameMatch[1].trim();
                // Filter out common words that aren't names
                const notNames = ['kitchen', 'bathroom', 'basement', 'deck', 'roof', 'new', 'estimate', 'invoice', 'high', 'main', 'oak', 'elm', 'maple'];
                const words = name.split(' ');
                if (!notNames.includes(words[0].toLowerCase())) {
                    document.getElementById('customerName').value = capitalize(name);
                    console.log('Found name:', name);
                    break;
                }
            }
        }
        
        // ===== 5. Extract Project Description =====
        // Common project types
        const projectTypes = [
            'kitchen remodel', 'kitchen renovation', 'bathroom remodel', 'bathroom renovation',
            'basement finishing', 'basement remodel', 'deck', 'deck building', 'deck repair',
            'roof repair', 'roofing', 'siding', 'window replacement', 'windows',
            'door installation', 'flooring', 'hardwood floors', 'tile work', 'tiling',
            'painting', 'interior painting', 'exterior painting', 'drywall', 'framing',
            'addition', 'home addition', 'garage', 'shed', 'fence', 'fencing',
            'plumbing', 'electrical', 'hvac', 'landscaping', 'concrete', 'masonry',
            'cabinet installation', 'countertops', 'backsplash', 'trim work', 'molding',
            'remodel', 'renovation', 'repair', 'installation', 'replacement'
        ];
        
        for (const proj of projectTypes) {
            if (text.includes(proj)) {
                document.getElementById('projectDesc').value = capitalize(proj);
                // Use this as line item description if we found a price
                if (foundPrice && !priceDescription) {
                    priceDescription = proj;
                }
                console.log('Found project:', proj);
                break;
            }
        }
        
        // ===== 6. Create Line Item if we found a price =====
        if (foundPrice) {
            // Clear empty line items first
            const tbody = document.getElementById('lineItemsBody');
            const existingRows = tbody.querySelectorAll('.line-item-row');
            existingRows.forEach(row => {
                const descInput = row.querySelector('input[type="text"]');
                const amtInput = row.querySelector('input[type="number"]');
                if (!descInput.value && !amtInput.value) {
                    row.remove();
                }
            });
            
            // Determine description
            let itemDesc = priceDescription || document.getElementById('projectDesc').value || 'Work';
            
            // Clean up description (remove filler words)
            itemDesc = itemDesc.replace(/\b(for|the|a|an|new|estimate|invoice|quote)\b/gi, '').trim();
            itemDesc = capitalize(itemDesc);
            
            addLineItem(itemDesc, foundPrice);
            itemsFound++;
            console.log('Added line item:', itemDesc, foundPrice);
        }
        
        // ===== 7. Look for multiple items (comma or "and" separated) =====
        // Pattern: "labor 500, materials 300, tile 800"
        const multiItemPattern = /([a-z]+(?:\s+[a-z]+)?)\s+\$?([\d,]+)/gi;
        let multiMatch;
        const addedItems = new Set();
        
        // Only look for multi-items if we haven't found a big single price
        if (!foundPrice || foundPrice < 1000) {
            while ((multiMatch = multiItemPattern.exec(text)) !== null) {
                const desc = multiMatch[1].trim();
                const price = parsePrice(multiMatch[2]);
                
                // Skip if it looks like phone, address, or already added
                if (!price || price < 50) continue;
                if (/^\d+$/.test(desc)) continue;
                if (/street|st|ave|road|rd|drive|dr|lane|ln/i.test(desc)) continue;
                
                const itemKey = desc.toLowerCase() + '-' + price;
                if (!addedItems.has(itemKey) && price !== foundPrice) {
                    addLineItem(capitalize(desc), price);
                    addedItems.add(itemKey);
                    itemsFound++;
                    console.log('Added multi-item:', desc, price);
                }
            }
        }

        // Ensure at least one line item row exists
        if (document.querySelectorAll('.line-item-row').length === 0) {
            addLineItem();
        }

        calculateTotal();

        // Update status
        document.getElementById('statusText').classList.remove('processing');
        
        const fieldsFound = [];
        if (document.getElementById('customerName').value) fieldsFound.push('name');
        if (document.getElementById('customerAddress').value) fieldsFound.push('address');
        if (document.getElementById('customerContact').value) fieldsFound.push('phone');
        if (document.getElementById('projectDesc').value) fieldsFound.push('project');
        if (itemsFound > 0) fieldsFound.push(itemsFound + ' item(s)');
        
        if (fieldsFound.length > 0) {
            document.getElementById('statusText').textContent = `Found: ${fieldsFound.join(', ')}. Review and edit.`;
            showToast(`Parsed successfully!`, 'success');
        } else {
            document.getElementById('statusText').textContent = 'Could not parse. Try speaking more clearly or add manually.';
            showToast('Could not parse input', 'error');
        }
    }

    // ========== Line Items ==========
    function addLineItem(description = '', amount = '') {
        lineItemCounter++;
        const tbody = document.getElementById('lineItemsBody');
        
        const row = document.createElement('tr');
        row.className = 'line-item-row';
        row.dataset.id = lineItemCounter;
        
        row.innerHTML = `
            <td>${lineItemCounter}</td>
            <td><input type="text" placeholder="Description" value="${description}" onchange="calculateTotal()"></td>
            <td>
                <button class="delete-item-btn" onclick="deleteLineItem(${lineItemCounter})" title="Delete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </td>
            <td><input type="number" placeholder="0.00" step="0.01" value="${amount}" onchange="calculateTotal()"></td>
        `;
        
        tbody.appendChild(row);
        calculateTotal();
    }

    function deleteLineItem(id) {
        const row = document.querySelector(`.line-item-row[data-id="${id}"]`);
        if (row) {
            row.remove();
            calculateTotal();
        }
    }

    function calculateTotal() {
        const rows = document.querySelectorAll('.line-item-row');
        let total = 0;
        
        rows.forEach(row => {
            const amountInput = row.querySelector('input[type="number"]');
            if (amountInput && amountInput.value) {
                total += parseFloat(amountInput.value) || 0;
            }
        });
        
        document.getElementById('grandTotal').textContent = '$' + total.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // ========== Document Type ==========
    function setDocType(type) {
        currentDoc.type = type;
        
        // Update toggle buttons
        document.querySelectorAll('.doc-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
        });
        
        // Update document display
        const isInvoice = type === 'invoice';
        document.getElementById('docTitle').textContent = isInvoice ? 'Invoice' : 'Estimate';
        document.getElementById('convertBtn').innerHTML = isInvoice 
            ? '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg> Convert to Estimate'
            : '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg> Convert to Invoice';
        
        // Update document number prefix
        generateDocNumber();
    }

    function generateDocNumber() {
        const prefix = currentDoc.type === 'invoice' ? 'INV' : 'EST';
        const saved = JSON.parse(localStorage.getItem('haibonDocs') || '[]');
        const typeCount = saved.filter(d => d.type === currentDoc.type).length + 1;
        currentDoc.number = `${prefix}-${String(typeCount).padStart(3, '0')}`;
        document.getElementById('docNumber').textContent = '#' + currentDoc.number;
    }

    function convertDocument() {
        const newType = currentDoc.type === 'estimate' ? 'invoice' : 'estimate';
        setDocType(newType);
        showToast(`Converted to ${newType}!`, 'success');
    }

    // ========== Save / Load ==========
    function gatherDocumentData() {
        const rows = document.querySelectorAll('.line-item-row');
        const lineItems = [];
        
        rows.forEach(row => {
            const descInput = row.querySelector('input[type="text"]');
            const amtInput = row.querySelector('input[type="number"]');
            if (descInput.value || amtInput.value) {
                lineItems.push({
                    description: descInput.value,
                    amount: parseFloat(amtInput.value) || 0
                });
            }
        });
        
        return {
            id: currentDoc.id || Date.now(),
            type: currentDoc.type,
            number: currentDoc.number,
            customerName: document.getElementById('customerName').value,
            customerAddress: document.getElementById('customerAddress').value,
            customerContact: document.getElementById('customerContact').value,
            date: document.getElementById('docDate').value,
            projectDesc: document.getElementById('projectDesc').value,
            lineItems: lineItems,
            notes: document.getElementById('docNotes').value,
            total: document.getElementById('grandTotal').textContent,
            createdAt: currentDoc.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
    }

    function saveDocument() {
        const docData = gatherDocumentData();
        let saved = JSON.parse(localStorage.getItem('haibonDocs') || '[]');
        
        // Update or add
        const existingIndex = saved.findIndex(d => d.id === docData.id);
        if (existingIndex >= 0) {
            saved[existingIndex] = docData;
        } else {
            saved.push(docData);
        }
        
        localStorage.setItem('haibonDocs', JSON.stringify(saved));
        currentDoc.id = docData.id;
        currentDoc.createdAt = docData.createdAt;
        
        showToast('Document saved!', 'success');
    }

    function loadDocument(id) {
        const saved = JSON.parse(localStorage.getItem('haibonDocs') || '[]');
        const doc = saved.find(d => d.id === id);
        
        if (!doc) return;
        
        currentDoc = { ...doc };
        
        // Set document type
        setDocType(doc.type);
        document.getElementById('docNumber').textContent = '#' + doc.number;
        
        // Fill form fields
        document.getElementById('customerName').value = doc.customerName || '';
        document.getElementById('customerAddress').value = doc.customerAddress || '';
        document.getElementById('customerContact').value = doc.customerContact || '';
        document.getElementById('docDate').value = doc.date || '';
        document.getElementById('projectDesc').value = doc.projectDesc || '';
        document.getElementById('docNotes').value = doc.notes || '';
        
        // Clear and add line items
        document.getElementById('lineItemsBody').innerHTML = '';
        lineItemCounter = 0;
        
        if (doc.lineItems && doc.lineItems.length > 0) {
            doc.lineItems.forEach(item => {
                addLineItem(item.description, item.amount);
            });
        } else {
            addLineItem();
        }
        
        calculateTotal();
        closeSavedDocs();
        showToast('Document loaded!', 'success');
    }

    function deleteDocument(id, event) {
        event.stopPropagation();
        
        if (!confirm('Delete this document?')) return;
        
        let saved = JSON.parse(localStorage.getItem('haibonDocs') || '[]');
        saved = saved.filter(d => d.id !== id);
        localStorage.setItem('haibonDocs', JSON.stringify(saved));
        
        renderSavedDocs();
        showToast('Document deleted', 'success');
    }

    // ========== Modal ==========
    function openSavedDocs() {
        renderSavedDocs();
        document.getElementById('savedDocsModal').classList.add('active');
    }

    function closeSavedDocs() {
        document.getElementById('savedDocsModal').classList.remove('active');
    }

    function renderSavedDocs() {
        const container = document.getElementById('savedDocsList');
        const saved = JSON.parse(localStorage.getItem('haibonDocs') || '[]');
        
        if (saved.length === 0) {
            container.innerHTML = '<div class="no-docs-message">No saved documents yet.<br>Create and save your first estimate or invoice!</div>';
            return;
        }
        
        // Sort by most recent
        saved.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        
        container.innerHTML = saved.map(doc => `
            <div class="saved-doc-item" onclick="loadDocument(${doc.id})">
                <h4>${doc.type === 'invoice' ? 'üìÑ' : 'üìù'} ${doc.number} - ${doc.customerName || 'No Customer'}</h4>
                <div class="saved-doc-meta">
                    <span>${doc.type.charAt(0).toUpperCase() + doc.type.slice(1)}</span>
                    <span>${doc.total}</span>
                    <span>${new Date(doc.date).toLocaleDateString()}</span>
                </div>
                <div class="saved-doc-actions">
                    <button class="action-btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteDocument(${doc.id}, event)">Delete</button>
                </div>
            </div>
        `).join('');
    }

    // ========== New Document ==========
    function newDocument() {
        if (!confirm('Start a new document? Unsaved changes will be lost.')) return;
        
        currentDoc = {
            id: null,
            type: 'estimate',
            number: '',
            customerName: '',
            customerAddress: '',
            customerContact: '',
            date: new Date().toISOString().split('T')[0],
            projectDesc: '',
            lineItems: [],
            notes: '',
            createdAt: null
        };
        
        document.getElementById('customerName').value = '';
        document.getElementById('customerAddress').value = '';
        document.getElementById('customerContact').value = '';
        document.getElementById('docDate').value = currentDoc.date;
        document.getElementById('projectDesc').value = '';
        document.getElementById('docNotes').value = '';
        
        document.getElementById('lineItemsBody').innerHTML = '';
        lineItemCounter = 0;
        
        setDocType('estimate');
        generateDocNumber();
        addLineItem();
        
        document.getElementById('statusText').textContent = 'Tap microphone to start';
        document.getElementById('transcriptPreview').textContent = '';
        
        showToast('New document started', 'success');
    }

    // ========== Toast ==========
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000)
